package pages

import (
	"fmt"
	"shs-web/actions"
	"shs-web/i18n"
	"shs-web/views/components"
)

templ PatientBloodTestResult(patient actions.Patient, btr actions.BloodTestResult, bt actions.BloodTest) {
	<div class={ "p-10" , "w-full", "flex", "flex-col", "gap-5" }>
		<h1 class="w-full font-bold text-2xl text-secondary">{ i18n.StringsCtx(ctx).BloodTestResult } &quot;{ btr.Name }&quot; { i18n.StringsCtx(ctx).For } { patient.FullName() }</h1>
		<hr/>
		if btr.Pending {
			<span class="w-full font-bold text-2xl text-[#DE3333]">{ i18n.StringsCtx(ctx).BloodTestPendingInfo }</span>
			<form
				class={ "flex", "flex-col", "gap-5", "max-w-1/3" }
				hx-encoding="application/json"
				hx-put={ fmt.Sprintf("/api/patient/%s/blood-test-result/%d/pending", patient.PublicId, btr.Id) }
				hx-ext="json-enc"
				hx-target="#status-msg"
				hx-swap="innerHTML"
				data-loading-target="#loading"
				data-loading-class-remove="hidden"
				_="on htmx:afterRequest call location.reload()"
			>
				for i := 0; i < len(bt.Fields); i++ {
					<div class={ "flex", "gap-10", "justify-between" }>
						@components.Input(components.InputOptions{
							Id:          newPatientBloodTestFormId(bt, bt.Fields[i]),
							Name:        newPatientBloodTestFormId(bt, bt.Fields[i]),
							Type:        components.InputTypeText,
							Required:    false,
							Autofocus:   false,
							Title:       bt.Fields[i].Name,
							Placeholder: i18n.StringsCtx(ctx).EnterBloodTestResultFieldValueFmt(bt.Fields[i].Unit),
							Class:       []string{"!min-w-[250px]"},
						})
						if len(bt.Fields)-i != 1 {
							@components.Input(components.InputOptions{
								Id:          newPatientBloodTestFormId(bt, bt.Fields[i+1]),
								Name:        newPatientBloodTestFormId(bt, bt.Fields[i+1]),
								Type:        components.InputTypeText,
								Required:    false,
								Autofocus:   false,
								Title:       bt.Fields[i+1].Name,
								Placeholder: i18n.StringsCtx(ctx).EnterBloodTestResultFieldValueFmt(bt.Fields[i+1].Unit),
								Class:       []string{"!min-w-[250px]"},
							})
							{{ i++ }}
						}
					</div>
				}
				<button type="submit" class={ "cursor-pointer" , "bg-secondary" , "rounded-[50px]" , "p-[10px]" , "px-[60px]", "w-full" , "text-accent" }>
					{ i18n.StringsCtx(ctx).FormsSubmit }
				</button>
				<div id="status-msg"></div>
			</form>
		} else {
			<table class={ "w-1/3" }>
				<tbody>
					<tr>
						<td>
							<b>{ i18n.StringsCtx(ctx).BloodTestDate }</b>
						</td>
						<td>
							{  btr.CreatedAt.Format("2006 Jan/02") }
						</td>
					</tr>
					for _, btField := range btr.FilledFields {
						<tr>
							<td>
								<b>
									{ btField.Name }
								</b>
							</td>
							<td>
								{ btField.ValueString }{ btField.Unit }
							</td>
						</tr>
					}
				</tbody>
			</table>
		}
	</div>
}
